      - name: Install build deps
        run: |
          pacman -Sy --noconfirm archlinux-keyring
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git go pacman-contrib fzf sudo

      - name: Create non-root user
        run: |
          useradd -m build
          chown -R build:build .

      - name: Build packages (all dirs containing PKGBUILD)
        run: |
          set -e
          shopt -s nullglob
          built=0

          for dir in */ ; do
            if [ -f "${dir}PKGBUILD" ]; then
              echo "==> Building: ${dir}"
              cd "${dir}"

              # IMPORTANT: no "-s" here (syncdeps triggers sudo prompt)
              su build -c "makepkg --noconfirm"

              mv *.pkg.tar.zst ..
              cd ..
              built=1
            fi
          done

          if [ "$built" -eq 0 ]; then
            echo "No packages found (no */PKGBUILD)."
            exit 1
          fi
